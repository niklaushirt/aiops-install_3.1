# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Postinstall Script for all CP4WAIOPS 3.1 components
#
# V3.1 
#
# ¬©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

export TEMP_PATH=~/aiops-install

# HACK for M1 Macs
export GODEBUG=asyncpreemptoff=1

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

set -o errexit
set -o pipefail
#set -o xtrace
source ./99_config-global.sh

export SCRIPT_PATH=$(pwd)
export LOG_PATH=""
__getClusterFQDN
__getInstallPath

banner
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "  "
__output "  CloudPak for Watson AI OPS 3.1 - Install Fluentbit"
__output "  "
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "  "
__output "  "



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Initialization
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header1Begin "Initializing"

header2Begin "Input Parameters" "magnifying"



        while getopts "t:" opt
        do
          case "$opt" in
              t ) FLUENTBIT_TOKEN="$OPTARG" ;;
          esac
        done



        if [[ $FLUENTBIT_TOKEN == "" ]];
        then
            __output "     ‚ùå You must provide the Humio Token for Fluentbit. Aborting...."
            __output "         Usage: $0 -t <TOKEN_FOR_HUMIO_AIOPS_REPOSITORY>"
            
            exit 1
        else
            __output "     ‚úÖ Humio Token for Fluentbit provided: $FLUENTBIT_TOKEN"
        fi



header2End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Checks
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header2Begin "Prerequisites Checks"

        getClusterFQDN

        check_and_install_oc
        check_and_install_helm

        checkKubeconfigIsSet
        

header2End




header2Begin "Fluentbit will be installed in Cluster '$CLUSTER_NAME'"

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# CONFIG SUMMARY
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       üîç Your configuration"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       üéõ  CLUSTER :                  $CLUSTER_NAME"
__output "       üõ∞  AI Manager NAMESPACE:      $WAIOPS_NAMESPACE"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       #Ô∏è‚É£  TEMP PATH:                 $INSTALL_PATH"
__output "       ---------------------------------------------------------------------------------------------------------------------------"
__output "  "
header2End


header1End "Initializing"


header1Begin "Install Fluentbit"

# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Installing Add-Ons that are independent from AIOPS Install
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    


        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Installing HUMIO
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        header2Begin "Install Fluentbit for HUMIO"
        
            if [[ $INSTALL_HUMIO == "true" ]]; 
            then
                oc adm policy add-scc-to-user privileged -n humio-logging -z humio-fluentbit-fluentbit-read

                helm install humio-fluentbit humio/humio-helm-charts \
                --namespace humio-logging \
                --set humio-fluentbit.token=$FLUENTBIT_TOKEN \
                --values ./tools/4_integrations/humio/humio-agent.yaml

                oc patch DaemonSet humio-fluentbit-fluentbit -n humio-logging -p '{"spec": {"template": {"spec": {"containers": [{"name": "humio-fluentbit","image": "fluent/fluent-bit:1.4.2","securityContext": {"privileged": true}}]}}}}' --type=merge

                oc apply -n humio-logging -f ./tools/4_integrations/humio/FluentbitDaemonSet_CUSTOM.yaml

                oc delete -n humio-logging pods -l k8s-app=humio-fluentbit

            else
                __output "     ‚ùå Humio is not enabled... Skipping"
            fi

        header2End 


      


header1End "Install Fluentbit"



__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output " ‚úÖ Fluentbit Installed"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"



