#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT MODIFY BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo "   __________  __ ___       _____    ________            "
echo "  / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____"
echo " / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/"
echo "/ /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) "
echo "\____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  "
echo "                                          /_/            "
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Load \"$INDEX_TYPE\" Indexes for $APP_NAME"
echo ""
echo "***************************************************************************************************************************************************"



#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Defaults
#--------------------------------------------------------------------------------------------------------------------------------------------

if [[ $APP_NAME == "" ]] ;
then
      echo "‚ö†Ô∏è AppName not defined. Launching this script directly?"
      echo "‚ùå Aborting..."
      exit 1
fi

if [[ $INDEX_TYPE == "" ]] ;
then
      echo "‚ö†Ô∏è Index Type not defined. Launching this script directly?"
      echo "‚ùå Aborting..."
      exit 1
fi


#--------------------------------------------------------------------------------------------------------------------------------------------
#  Get Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************************"
echo "  üîê  Getting credentials"
echo "***************************************************************************************************************************************************"
oc project $WAIOPS_NAMESPACE >$log_output_path 2>&1  || true


export username=$(oc get secret $(oc get secrets | grep ibm-elasticsearch-secret | awk '!/-min/' | awk '{print $1;}') -o jsonpath="{.data.username}"| base64 --decode)
export password=$(oc get secret $(oc get secrets | grep ibm-elasticsearch-secret | awk '!/-min/' | awk '{print $1;}') -o jsonpath="{.data.password}"| base64 --decode)

export WORKING_DIR_ES="./training/TRAINING_FILES/ELASTIC/$APP_NAME/$INDEX_TYPE"


echo "      ‚úÖ OK"
echo ""
echo ""



#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************************"
echo "  üîó  Checking credentials"
echo "***************************************************************************************************************************************************"

if [[ $username == "" ]] ;
then
      echo "‚ùå Could not get Elasticsearch Username. Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Elasticsearch Username"
fi

if [[ $password == "" ]] ;
then
      echo "‚ùå Could not get Elasticsearch Password. Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Elasticsearch Password"
fi



echo ""
echo ""
echo ""
echo ""


echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  üîé  Parameter for ElasicSearch Index Load for $APP_NAME"
echo "  "
echo "           üß∞ Index Type                  : $INDEX_TYPE"
echo "  "
echo "           üôé‚Äç‚ôÇÔ∏è User                        : $username"
echo "           üîê Password                    : $password"
echo "  "
echo "  "
echo "           üìÇ Directory for Indexes       : $WORKING_DIR_ES"
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  üóÑÔ∏è  Indexes to be loaded"
echo "***************************************************************************************************************************************************"
ls -1 $WORKING_DIR_ES | grep "json"
echo "  "
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"

echo ""
echo ""


echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
  read -p " ‚ùó‚ùì Start Loading? [y,N] " DO_COMM
  if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
      echo "   ‚úÖ Ok, continuing..."
      echo ""
      echo ""
      echo ""
      echo ""

  else
    echo "‚ùå Aborted"
    exit 1
  fi
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""

#--------------------------------------------------------------------------------------------------------------------------------------------
#  Import Indexes
#--------------------------------------------------------------------------------------------------------------------------------------------
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo " üöÄ  Launching Index Load" 
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""



echo "    ***************************************************************************************************************************************************"
echo "      üõ†Ô∏è  Getting exising Indexes"
echo "    ***************************************************************************************************************************************************"

export existingIndexes=$(curl -s -k -u $username:$password -XGET https://localhost:9200/_cat/indices) >$log_output_path 2>&1


if [[ $existingIndexes == "" ]] ;
then
      echo "‚ùó Please start port forward in separate terminal."
      echo "‚ùó Run the following:"
      echo "    while true; do oc port-forward statefulset/$(oc get statefulset | grep es-server-all | awk '{print $1}') 9200; done"
      echo "‚ùå Aborting..."
      exit 1
fi
echo "      ‚úÖ OK"
echo ""
echo ""



export NODE_TLS_REJECT_UNAUTHORIZED=0

for actFile in $(ls -1 $WORKING_DIR_ES | grep "json"); 
do 

      echo "    ***************************************************************************************************************************************************"
      echo "        üõ†Ô∏è  Uploading Index: ${actFile%".json"}" 
      echo "    ***************************************************************************************************************************************************"

      if [[ $existingIndexes =~ "${actFile%".json"}" ]] ;
      then
            curl -k -u $username:$password -XGET https://localhost:9200/_cat/indices | grep ${actFile%".json"} | sort
            echo "‚ö†Ô∏è  Index already exist in Cluster."
            read -p " ‚ùó‚ùì Append or Replace? [r,A] " DO_COMM
            if [[ $DO_COMM == "r" ||  $DO_COMM == "R" ]]; then
                        read -p " ‚ùó‚ùì Are you sure that you want to delete and replace the Index? [y,N] " DO_COMM
                        if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
                              echo "   ‚úÖ Ok, continuing..."
                              echo ""
                              echo ""
                              echo "    ***************************************************************************************************************************************************"
                              echo "        ‚ùå  Deleting Index: ${actFile%".json"}" 
                              echo "    ***************************************************************************************************************************************************"
                              curl -k -u $username:$password -XDELETE https://$username:$password@localhost:9200/${actFile%".json"}
                              echo ""
                              echo ""

                        else
                              echo "‚ùå Aborted"
                              exit 1
                        fi

            else
                  echo "   ‚úÖ Ok, continuing..."
            fi

      fi



      elasticdump --input="$WORKING_DIR_ES/${actFile}" --output=https://$username:$password@localhost:9200/${actFile%".json"} --type=data --limit=1000;
      echo "   ‚úÖ  OK"
done

echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "      üõ†Ô∏è  Getting all Indexes"
echo "***************************************************************************************************************************************************"
curl -k -u $username:$password -XGET https://localhost:9200/_cat/indices | sort
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"






echo ""
echo ""
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Load \"$INDEX_TYPE\" Indexes for $APP_NAME"
echo " ‚úÖ  Done..... "
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"


