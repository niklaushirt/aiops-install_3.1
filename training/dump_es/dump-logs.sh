#while true; do oc port-forward statefulset/$(oc get statefulset | grep es-server-all | awk '{print $1}') 9200; done


export WORKING_DIR="./training/dump_es/DUMP_LOGS/logs"


#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT MODIFY BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

source ./tools/0_global/99_config-global.sh

export SCRIPT_PATH=$(pwd)
export LOG_PATH=""
__getClusterFQDN
__getInstallPath


banner
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Dump LOGS Indexes"
echo ""
echo "***************************************************************************************************************************************************"



  read -p "Start Dump? [y,N] " DO_COMM
  if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
      echo "‚úÖ Ok, continuing..."
  else
    echo "‚ùå Aborted"
    exit 1
  fi

oc project $WAIOPS_NAMESPACE>$log_output_path 2>&1


echo "***************************************************************************************************************************************************"
echo "  Geting credentials"
echo "***************************************************************************************************************************************************"



export username=$(oc get secret $(oc get secrets | grep ibm-elasticsearch-secret | awk '!/-min/' | awk '{print $1;}') -o jsonpath="{.data.username}"| base64 --decode)
export password=$(oc get secret $(oc get secrets | grep ibm-elasticsearch-secret | awk '!/-min/' | awk '{print $1;}') -o jsonpath="{.data.password}"| base64 --decode)
echo "   ‚úÖ  OK"


echo "***************************************************************************************************************************************************"
echo "  "
echo "   üîé  Dumping LOG indexes"
echo "  "
echo "           Data Files  : $WORKING_DIR"
echo "  "
echo "           User        : $username"
echo "           Password    : $password"
echo "  "
echo "***************************************************************************************************************************************************"



export existingIndexes=$(curl -k -u $username:$password -XGET https://localhost:9200/_cat/indices) >$log_output_path 2>&1


if [[ $existingIndexes == "" ]] ;
then
    echo "‚ùó Please start port forward in separate terminal."
    echo "‚ùó Run the following:"
    echo "    while true; do oc port-forward statefulset/$(oc get statefulset | grep es-server-all | awk '{print $1}') 9200; done"
    echo "‚ùå Aborting..."
    exit 1
fi


echo "   ‚úÖ  OK"


mkdir -p $WORKING_DIR
rm $WORKING_DIR/*.json

export NODE_TLS_REJECT_UNAUTHORIZED=0

echo "***************************************************************************************************************************************************"
echo "   üîé  LOGS indexes"
echo "***************************************************************************************************************************************************"

for index in $(curl -k -u $username:$password -XGET https://localhost:9200/_cat/indices | sort | grep "logtrain" | awk '{print $3}'); 
do
  echo "***************************************************************************************************************************************************"
  echo "   üíæ  Dumping Index ${index}.json"
  elasticdump --input=https://$username:$password@localhost:9200/${index} --limit=5000 --output="$WORKING_DIR/${index}.json" --type=data; 
done





echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " ‚úÖ  DONE: CP4WAIOPS Dump LOGS Indexes"
echo ""
echo "***************************************************************************************************************************************************"


