# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Install Script for Open LDAP
#
# V3.1 
#
# ©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

headerModuleFileBegin "Install Open LDAP " $0

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# INSTALL CHECKS
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
header3Begin "Install Checks"


        getInstallPath

        BASE_DN="dc="$(echo $LDAP_DOMAIN | ${SED} -e "s/\./,dc=/")
        BIND_DN="cn=admin,"$BASE_DN


        checkAlreadyInstalled app=openldap default
        if [[ $ALREADY_INSTALLED == 1 ]];
        then
            __output "    ⭕ LDAP already installed! Skipping..."

            headerModuleFileEnd "Install Open LDAP " $0
            exit 0
        fi

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PREREQUISITES
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Running Prerequisites" "rocket"

        export SCRIPT_PATH=$(pwd)

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Klusterlet
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Install OpenLDAP" "rocket"


      __output "Install OpenLDAP Helm Chart"

      $HELM_BIN install openldap ./tools/1_ldap/openldap -n default \
          --set OpenLdap.Domain="ibm.com" \
          --set OpenLdap.AdminPassword=P4ssw0rd! \
          --set OpenLdap.SeedUsers.usergroup=mcm \
          --set OpenLdap.SeedUsers.userlist=mcm \
          --set OpenLdap.SeedUsers.passw0rd=P4ssw0rd! \
          --set OpenLdap.Route=$CLUSTER_NAME || true

header3End


headerModuleFileEnd "Install Open LDAP " $0




