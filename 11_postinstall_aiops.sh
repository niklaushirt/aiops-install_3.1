# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Postinstall Script for all CP4WAIOPS 3.1 components
#
# V3.1 
#
# Â©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

export TEMP_PATH=~/aiops-install

# HACK for M1 Macs
export GODEBUG=asyncpreemptoff=1

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

set -o errexit
set -o pipefail
#set -o xtrace
source ./99_config-global.sh

export SCRIPT_PATH=$(pwd)
export LOG_PATH=""
__getClusterFQDN
__getInstallPath

banner
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "  "
__output "  CloudPak for Watson AI OPS 3.1 - Post Install"
__output "  "
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"
__output "  "
__output "  "



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Initialization
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header1Begin "Initializing"

header2Begin "Input Parameters" "magnifying"



        while getopts "o:" opt
        do
          case "$opt" in
              o ) OVERRIDE="$OPTARG" ;;
          esac
        done



        if [[ $OVERRIDE == "true" ]];
        then
           export OVERRIDE_CHECKS=true
            __output "     âš ï¸ Warning: You have chosen to override install checks!"
        else
           export OVERRIDE_CHECKS=false
        fi


        export STORAGE_CLASS_FILE=$WAIOPS_STORAGE_CLASS_FILE

header2End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Checks
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header2Begin "Prerequisites Checks"

        getClusterFQDN
        
        #getHosts

        #check_and_install_jq
        check_and_install_cloudctl
        #check_and_install_kubectl
        check_and_install_oc
        check_and_install_helm
        checkHelmExecutable
        #check_and_install_yq
        #dockerRunning
        #checkOpenshiftReachable
        checkKubeconfigIsSet
        #checkRegistryCredentials
        

header2End




header2Begin "CloudPak for Watson AI OPS 3.1 (CP4WAIOPS) will be installed in Cluster '$CLUSTER_NAME'"

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# CONFIG SUMMARY
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       ðŸ” Your configuration"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       ðŸŽ›  CLUSTER :                  $CLUSTER_NAME"
__output "       ðŸ›°  AI Manager NAMESPACE:      $WAIOPS_NAMESPACE"
__output "       ðŸ“› INSTANCE NAME :            $WAIOPS_NAME"
__output "       ðŸ“¦ INSTANCE SIZE :            $WAIOPS_SIZE"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       ðŸ’¾ STORAGE CLASS:             $WAIOPS_STORAGE_CLASS_FILE"
__output "       ðŸ’¾ STORAGE CLASS LARGE:       $WAIOPS_STORAGE_CLASS_LARGE_BLOCK"
__output "       ---------------------------------------------------------------------------------------------------------------------"
__output "       #ï¸âƒ£  TEMP PATH:                 $INSTALL_PATH"
__output "       ---------------------------------------------------------------------------------------------------------------------------"
__output "  "
header2End



header2Begin "CloudPak for Watson AI OPS  3.1 (CP4WAIOPS) will be installed with the following features:"
printComponentsInstall
header2End

header1End "Initializing"





header1Begin "Post-Install - Independent from CP4WAIOPS"

# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Installing Add-Ons that are independent from AIOPS Install
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    


        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Installing HUMIO
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        header2Begin "Install HUMIO"
        
            if [[ $INSTALL_HUMIO == "true" ]]; 
            then
                # --------------------------------------------------------------------------------------------------------------------------------
                #  INSTALL
                # --------------------------------------------------------------------------------------------------------------------------------
                ./41_addon_install_humio.sh

            else
                __output "     âŒ Humio is not enabled... Skipping"
            fi

        header2End 


        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Installing LDAP
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
        header2Begin "LDAP - Install"

            if [[ $INSTALL_LDAP == "true" ]]; 
            then

                # --------------------------------------------------------------------------------------------------------------------------------
                #  INSTALL
                # --------------------------------------------------------------------------------------------------------------------------------
                ./42_addon_install_ldap.sh

            else
                __output "     âŒ LDAP is not enabled... Skipping"
            fi
        header2End



        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Create Demo User
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
        header2Begin "Create OCP User"

            oc project $WAIOPS_NAMESPACE 
            
            oc create serviceaccount -n default demo-admin >/dev/null 2>&1 || true
            oc create clusterrolebinding test-admin --clusterrole=cluster-admin --serviceaccount=default:demo-admin >/dev/null 2>&1 || true

            __output "      âœ… OK"

        header2End




        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Install Demo Apps
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            
        header2Begin "Install Demo Apps"


            if [[ $INSTALL_DEMO == "true" ]]; 
            then

                APP_INSTALLED=$(oc get ns kubetoy || true) 
                if [[ $APP_INSTALLED =~ "Active" ]]; 
                then
                    __output "     â­• Kubetoy already installed... Skipping"
                else
                    header2Begin "Install Kubetoy"
                        oc create ns kubetoy >/dev/null 2>&1
                        oc apply -n kubetoy -f ./demo_install/kubetoy/kubetoy_all_in_one.yaml >/dev/null 2>&1
                        
                        __output "      âœ… OK"

                    header2End
                fi


                APP_INSTALLED=$(oc get ns robot-shop || true) 
                if [[ $APP_INSTALLED =~ "Active" ]]; 
                then
                    __output "     â­• RobotShop already installed... Skipping"
                else
                    header2Begin "Install RobotShop"
                        oc create ns robot-shop >/dev/null 2>&1
                        oc adm policy add-scc-to-user privileged -n robot-shop -z robot-shop >/dev/null 2>&1
                        oc create clusterrolebinding default-robotinfo1-admin --clusterrole=cluster-admin --serviceaccount=robot-shop:robot-shop >/dev/null 2>&1
                        oc adm policy add-scc-to-user privileged -n robot-shop -z default >/dev/null 2>&1                                           î‚² âœ˜
                        oc create clusterrolebinding default-robotinfo2-admin --clusterrole=cluster-admin --serviceaccount=robot-shop:default >/dev/null 2>&1
                        oc apply -f ./demo_install/robotshop/robot-all-in-one.yaml -n robot-shop >/dev/null 2>&1
                        oc apply -n robot-shop -f ./demo_install/robotshop/load-deployment.yaml >/dev/null 2>&1
                        
                        __output "      âœ… OK"

                    header3End
                fi


                APP_INSTALLED=$(oc get ns qotd || true) 
                if [[ $APP_INSTALLED =~ "Active" ]]; 
                then
                    __output "     â­• Quote of the Day already installed... Skipping"
                else
                    header2Begin "Install Quote of the Day"
                    oc new-project qotd
                    oc adm policy add-scc-to-user anyuid -z default
                    oc apply -f ./demo_install/qotd/k8s
                        
                        __output "      âœ… OK"

                    header3End
                fi




            else
                __output "     âŒ Demo Apps are not enabled... Skipping"
            fi
        header2End "Install Demo Apps"



        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Patch Ingress 
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        header2Begin "Patch Ingress"

                    endpointPublishingStrategy=$(oc get ingresscontroller default -n openshift-ingress-operator -o yaml | grep HostNetwork || true) 

                    if [[ $endpointPublishingStrategy =~ "HostNetwork" ]]; 
                    then
                        header2Begin "Patch Ingress"
                            oc patch namespace default --type=json -p '[{"op":"add","path":"/metadata/labels","value":{"network.openshift.io/policy-group":"ingress"}}]' >/dev/null 2>&1
                            __output "     âœ… Ingress successfully patched"
                        header2End
                    else
                        __output "     â­• Not needed... Skipping"
                    fi
        header2End "Patch Ingress"






        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Create Routes
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        header2Begin "Create Topology Routes"

            header3Begin "Create Topology Merge Route"
                    oc create route passthrough topology-merge -n $WAIOPS_NAMESPACE --service=evtmanager-topology-merge --port=merge-api >/dev/null 2>&1  || true
                __output "      âœ… OK"

            header3End

            header3Begin "Create Topology Rest Route"
                    oc create route passthrough topology-rest -n $WAIOPS_NAMESPACE --service=evtmanager-topology-rest-observer --port=rest-observer-api >/dev/null 2>&1  || true
                __output "      âœ… OK"

            header3End



        header2End "Create Topology Routes"



        header2Begin "Create Flink Job Manager Routes"

            header3Begin "Create Flink Job Manager Route"
                oc create route passthrough job-manager -n $WAIOPS_NAMESPACE --service=aimanager-ibm-flink-job-manager --port=8000 >/dev/null 2>&1 || true
                __output "      âœ… OK"

            header3End

        header2End "Create Flink Job Manager Routes"



        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Installing Add-Ons that are dependent on Common Services
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # This can only be done if the CS install is finished
 if [[ $OVERRIDE_CHECKS == "false" ]]; 
                    then

        header2Begin "Install Checks"
                checkCSDone
                __output "      âœ… OK: Common Services are Ready"
        header2End
fi

        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Register LDAP
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------    



        header2Begin "Register LDAP"


                header3Begin "LDAP - Register"

                    if [[ $INSTALL_LDAP == "true" ]]; 
                    then

                        # --------------------------------------------------------------------------------------------------------------------------------
                        #  INSTALL
                        # --------------------------------------------------------------------------------------------------------------------------------
                        ./43_addon_register_ldap.sh
                        __output "      âœ… OK"

                    else
                        __output "     âŒ LDAP is not enabled... Skipping"
                    fi
                header3End


        header2End "Register LDAP"


        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Create Strimzi Route
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        header2Begin "Create Strimzi Route"

            header3Begin "Create Strimzi Route"
                oc patch Kafka strimzi-cluster -n  $WAIOPS_NAMESPACE -p '{"spec": {"kafka": {"listeners": {"external": {"type": "route"}}}}}' --type=merge >/dev/null 2>&1 || true
                __output "      âœ… OK"
            header3End

        header2End "Create Strimzi Route"





        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Adapt Slack Welcome Message
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        header2Begin "Adapt Slack Welcome Message"

            header3Begin "Patch Environment"
                  oc set env deployment/$(oc get deploy -l app.kubernetes.io/component=chatops-slack-integrator -o jsonpath='{.items[*].metadata.name }') SLACK_WELCOME_COMMAND_NAME=/welcome >/dev/null 2>&1 || true
                __output "      âœ… OK"
            header3End

        header2End "Adapt Slack Welcome Message"



        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Patch Resources for ROKS
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        header2Begin "Patch Resources for ROKS"

            header3Begin "Patch evtmanager-topology-merge"

               oc patch deployment evtmanager-topology-merge -n aiops --patch-file ./yaml/waiops/topology-merge-patch.yaml || true
                __output "      âœ… OK"
            header3End

            header3Begin "Patch evtmanager-ibm-hdm-analytics-dev-inferenceservice"
                oc patch deployment evtmanager-ibm-hdm-analytics-dev-inferenceservice -n aiops --patch-file ./yaml/waiops/evtmanager-inferenceservice-patch.yaml
                __output "      âœ… OK"
            header3End



        header2End "Create Gateway"






        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # Install Gateway
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        header2Begin "Create Gateway"

            header3Begin "Create Gateway for all Events Severity > 2"

                cp ./yaml/gateway/gateway-generic-template.yaml /tmp/gateway-generic.yaml
                ${SED} -i "s/<CP4WAIOPS_NAMESPACE>/$WAIOPS_NAMESPACE/" /tmp/gateway-generic.yaml
                oc apply -n $WAIOPS_NAMESPACE -f /tmp/gateway-generic.yaml || true
                __output "      âœ… OK"
            header3End

            header3Begin "Adapt Gateway to be able to connect (HACK)"
                oc apply -n aiops -f ./yaml/gateway/gateway_cr_cm.yaml || true
                oc delete pod -n aiops $(oc get po -n aiops|grep event-gateway-generic|awk '{print$1}') || true
                __output "      âœ… OK"
            header3End



        header2End "Create Gateway"



header1End "Post-Install - Independent from CP4WAIOPS"


checkInstallDone


__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output " âœ… CP4WAIOPS Base Elements Installed"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "----------------------------------------------------------------------------------------------------------------------------------------------------"
__output "***************************************************************************************************************************************************"
__output "***************************************************************************************************************************************************"





__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""
__output ""


printCredentials